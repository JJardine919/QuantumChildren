 import { createClientFromRequest } from "npm:@base44/sdk";

  Deno.serve(async (req) => {
    try {
      // Check the API key from your collection server
      const apiKey = req.headers.get('X-QC-API-Key');
      const expectedKey = Deno.env.get('QC_WEBHOOK_KEY');

      if (!apiKey || apiKey !== expectedKey) {
        return Response.json({ error: 'Unauthorized' }, { status: 401 });
      }

      const signalData = await req.json();
      const base44 = createClientFromRequest(req);

      // Update or create the node (admin permissions)
      const existingNodes = await base44.asServiceRole.entities.NetworkNode.filter({
        node_id: signalData.node_id
      });

      if (existingNodes.length > 0) {
        const node = existingNodes[0];
        await base44.asServiceRole.entities.NetworkNode.update(node.id, {
          last_seen: new Date().toISOString(),
          signals_sent: (node.signals_sent || 0) + 1,
          status: 'active'
        });
      } else {
        await base44.asServiceRole.entities.NetworkNode.create({
          node_id: signalData.node_id,
          registered_at: new Date().toISOString(),
          last_seen: new Date().toISOString(),
          signals_sent: 1,
          status: 'new'
        });
      }

      // Save the signal
      const signal = await base44.asServiceRole.entities.TradingSignal.create({
        node_id: signalData.node_id,
        symbol: signalData.symbol,
        direction: signalData.direction,
        confidence: signalData.confidence,
        quantum_entropy: signalData.quantum_entropy,
        dominant_state: signalData.dominant_state,
        price_at_signal: signalData.price_at_signal,
        timestamp: signalData.timestamp || new Date().toISOString(),
        outcome: 'PENDING'
      });

      return Response.json({ success: true, signal_id: signal.id });

    } catch (error) {
      console.error('ingestSignal error:', error);
      return Response.json({ error: 'Request failed' }, { status: 500 });
    }
  });